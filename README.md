# TerraVixens

Infrastructure as Code for Vixens homelab using Terraform and Talos Linux.

## Overview

This repository contains the Terraform infrastructure layer that provisions:
- Talos Linux clusters (immutable, API-driven Kubernetes OS)
- Cilium CNI (eBPF-based networking)
- ArgoCD bootstrap (GitOps controller)

**Applications and GitOps:** See [vixens](https://github.com/charchess/vixens) repository.

## Repository Structure

```
terravixens/
├── terraform/
│   ├── modules/           # Reusable Terraform modules
│   │   ├── shared/        # DRY module (single source of truth)
│   │   ├── talos/         # Talos cluster provisioning
│   │   ├── cilium/        # Cilium CNI
│   │   └── argocd/        # ArgoCD bootstrap
│   ├── base/              # Base configuration
│   └── environments/
│       ├── dev/           # Development cluster
│       ├── test/          # Test cluster
│       ├── staging/       # Staging cluster
│       └── prod/          # Production cluster
├── docs/                  # Infrastructure documentation
└── scripts/               # Infrastructure scripts
```

## Quick Start

### Prerequisites

- Terraform >= 1.10
- Talos CLI (talosctl)
- kubectl

### Working with Dev Environment

```bash
cd terraform/environments/dev

# Set environment variables
export KUBECONFIG=$(pwd)/kubeconfig-dev
export TALOSCONFIG=$(pwd)/talosconfig-dev

# Standard workflow
terraform init
terraform validate
terraform plan
terraform apply
```

### Environment Configuration

Each environment has:
- Dedicated VLAN configuration (internal + services)
- Independent Kubernetes cluster
- Separate Terraform state

| Environment | Nodes | VLAN Internal | VLAN Services | VIP |
|-------------|-------|---------------|---------------|-----|
| Dev | obsy, onyx, opale | 111 | 208 | 192.168.111.160 |
| Test | citrine, carny, celesty | 111 | 209 | 192.168.111.180 |
| Staging | TBD | 111 | 210 | 192.168.111.190 |
| Prod | Physical nodes | 111 | 201 | 192.168.111.200 |

## Infrastructure Stack

- **OS:** Talos Linux v1.11.0
- **Kubernetes:** v1.34.0
- **CNI:** Cilium v1.18.3 (eBPF, kube-proxy replacement)
- **GitOps:** ArgoCD v7.7.7 (bootstrapped, then self-managed)
- **LoadBalancer:** Cilium L2 Announcements + LB IPAM
- **Storage:** Synology NAS (192.168.111.69)

## Documentation

See [docs/](docs/) for detailed documentation:
- Architecture decisions
- Terraform procedures
- Network configuration
- Troubleshooting

## Related Repositories

- **[vixens](https://github.com/charchess/vixens)** - GitOps applications (ArgoCD, apps, Kustomize)

## Workflow

1. **Infrastructure changes:** This repo (terravixens)
2. **Application changes:** vixens repo
3. **Config files:** kubeconfig/talosconfig generated by Terraform in each environment

**Important:** This is the infrastructure layer. Application deployments are managed via ArgoCD from the vixens repository.
